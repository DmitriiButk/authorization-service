# Сервис Аутентификации и Авторизации

## Описание

Backend-приложение, реализующее собственную систему аутентификации и авторизации на основе ролевой модели доступа (RBAC). Сервис предоставляет REST API для полного цикла управления пользователями и их правами доступа к ресурсам.

Проект выполнен в соответствии с тестовым заданием и не использует встроенные в фреймворк системы авторизации «из коробки».

---

## 1. Система разграничения прав доступа (RBAC)

В основе системы лежит модель **Role-Based Access Control (RBAC)**, которая управляет доступом на основе ролей, назначенных пользователям.

### Основные компоненты:

-   **Пользователи (Users)**: Учетные записи, которым назначаются роли.
-   **Роли (Roles)**: Группы разрешений (например, `admin`, `user`).
-   **Разрешения (Permissions)**: Конкретные права на выполнение действий (например, `manage_roles`, `view_user_resource`).

### Схема базы данных:

-   `users`: Таблица пользователей.
-   `roles`: Справочник ролей.
-   `permissions`: Справочник разрешений.
-   `user_roles`: Связь «многие-ко-многим» между пользователями и ролями.
-   `role_permissions`: Связь «многие-ко-многим» между ролями и разрешениями.

### Логика работы:

1.  При запуске приложения база данных автоматически заполняется начальными данными: создаются роли `admin` и `user`, набор разрешений, и пользователь-администратор.
2.  При регистрации новому пользователю по умолчанию присваивается роль `user`.
3.  Защищенные эндпоинты проверяют JWT токен и наличие у пользователя необходимых разрешений. При отсутствии токена возвращается ошибка **401 Unauthorized**, при отсутствии прав — **403 Forbidden**.

---

## 2. Функционал и API

### Модуль 1: Взаимодействие с пользователем

-   `POST /api/v1/auth/register`: Регистрация нового пользователя (имя, email, пароль). По умолчанию присваивается роль `user`.
-   `POST /api/v1/auth/login`: Аутентификация по email и паролю, получение пары JWT токенов (access и refresh).
-   `POST /api/v1/auth/logout`: Выход из системы (на клиенте).
-   `GET /api/v1/users/me`: Получение информации о текущем пользователе.
-   `PATCH /api/v1/users/me`: Обновление данных своего профиля (имя, email, пароль).
-   `DELETE /api/v1/users/me`: «Мягкое» удаление своего аккаунта (устанавливается флаг `is_active=False`).

### Модуль 2: API для администратора (управление правами)

*Все эндпоинты требуют прав администратора.*

-   `POST /api/v1/admin/roles`: Создание новой роли.
-   `POST /api/v1/admin/permissions`: Создание нового разрешения.
-   `POST /api/v1/admin/roles/{role_name}/permissions`: Назначение разрешения роли.
-   `POST /api/v1/admin/users/{user_id}/roles`: Назначение роли пользователю.

### Модуль 3: Mock-ресурсы для демонстрации прав

-   `GET /api/v1/resources/public`: Общедоступный ресурс.
-   `GET /api/v1/resources/user`: Ресурс, доступный пользователям с ролью `user` (требует право `view_user_resource`).
-   `GET /api/v1/resources/admin`: Ресурс, доступный пользователям с ролью `admin` (требует право `view_admin_resource`).

---

## 3. Запуск и использование

### Требования

-   Docker
-   Docker Compose

### Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/DmitriiButk/authorization-service.git
    cd authorization-service/app
    ```

2.  **Создайте файл `.env`** в директории `app` со следующими переменными:
    ```
    POSTGRES_USER=user
    POSTGRES_PASSWORD=password
    POSTGRES_DB=auth_db

    JWT_SECRET_KEY=your_super_secret_key
    JWT_ALGORITHM=HS256
    ```

3.  **Запустите приложение с помощью Docker Compose:**
    ```bash
    docker-compose up -d --build
    ```
    При первом запуске база данных будет автоматически создана и заполнена тестовыми данными.

### Документация API

После запуска документация Swagger UI будет доступна по адресу:
**http://localhost:8000/docs**

### Администратор по умолчанию

-   **Логин:** `admin@example.com`
-   **Пароль:** `adminpassword`

---

## 4. Качество кода

Проект использует линтер и форматер **Ruff** для поддержания чистоты и консистентности кодовой базы.

### Проверка и форматирование

1.  **Если Ruff ещё не установлен, установи его**
    ```bash
    pip install ruff
    ```

2.  **Выполните команды:**
    ```bash
    # Проверить код на наличие ошибок и стилистических проблем
    ruff check .

    # Автоматически исправить большинство найденных проблем
    ruff check . --fix

    # Отформатировать код (включая сортировку импортов)
    ruff format .
    ```

---

## 5. Технологии

-   FastAPI
-   PostgreSQL
-   SQLAlchemy
-   Pydantic
-   JWT (PyJWT)
-   Passlib & Bcrypt
-   Docker & Docker Compose
-   Uvicorn
-   Ruff
